# speech-api-pipeline
## explanation of this system

![system-diagram](https://user-images.githubusercontent.com/12594994/40313986-19352b74-5d52-11e8-8332-7d3993fd73de.png)

I want to automate transcribing audio to text using GCP Speech API.
This system is planned for the purpose.

GCP Speech API needs long audio file to put in Google Cloud Storage（GCS）.
This API can't process stereo audio and specific audio（ex.mp3）.
So, in addition to automate uploading audio to GCS, pre-treatment pipeline which convert audio to suitable format is needed.

All cloud resources for the purpose shall be generated by Terraform, using main.tf of this repository.
I also wrote python script to detect generating audio file at specific directory and to send it suitable pipeline depends on audio format.

## preparation

* Create AWS and GCP account, and generate IAM and credentials to controll each cloud resources.
	* This architecture is consist of resources as bellow.
		* AWS：S3, Lambda, Elastic Transcoder
		* GCP：Cloud Storage, Cloud Functions, Speech API
* Install Terraform on your PC, and define environmental variables which are suitable for the credentials of AWS and GCP
	* AWS: https://www.terraform.io/docs/providers/aws/index.html
	* GCP: https://www.terraform.io/docs/providers/google/index.html
* Distribute local-pc-resources/watchdog_rpi.py to your device for recording talking.
    * Using not python2 but python3 to execute watchdog_rpi.py.
	* Installing libralies using local-pc-resources/requirements.txt on the device.
	* Doing ***yum install ffmpeg*** or ***avconv*** may be required for Pydub(one of the python libraries).
	* Define environmental variables is also needed for executing python script.
		* AWS: https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-environment.html
		* GCP: https://cloud.google.com/docs/authentication/production
* Unzip transfer-s3flac-to-gcs.zip, modify gcp-develop-key.json according to your actual GCP project and rezip these files. 
* Do ***terraform apply*** to generate all cloud resources.
* Some minor adjustment is needed for two scripts
	* watchdog_rpi.py: change gcs and s3 bucket name to generated bucket name
	* transcribe-flac-to-text(generated Cloud Function): change name of gcs bucket put translated text to bucket name generated by terraform.

## explanation files of this repositry

* convert-audio-to-monoral-flac.py 
	* Source code of Lambda which convert audio file to monoral flac using Elastic Transcoder.
* transfer-s3flac-to-gcs.py 
	* Source code of Lambda which transfer monoral flac to GCS.
* convert-audio-to-monoral-flac.zip, transfer-s3flac-to-gcs.zip 
	* Zip for Lambda generated by Terraform.
* cloud-functions-sources（Folder）
	* Sources of GCP Cloud Functions which transcribe audio to text using Speech API
		* index.js: node.js code of GCP Cloud Functions.
		* package.json: package.json of this function.
* transcribe-flac-to-text.zip 
	* Zip for GCP Cloud Functions generated by Terraform.
* main.tf 
	* HCL code of Terraform generating all cloud resources for this system.
* local-pc-resources（Folder）
	* Sources for Local PC managing raw audio files.
		* watchdog_rpi.py: Python script to detect generating audio file at specific directory and to send it suitable pipeline depends on audio format.
		* requirements.txt: requirements.txt of watchdog_rpi.py for pip.